<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ED2Ké“¾æ¥å‡€åŒ–å™¨</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        
        .input-section, .output-section {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            color: #555;
        }
        
        textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            resize: vertical;
            box-sizing: border-box;
        }
        
        textarea:focus {
            outline: none;
            border-color: #4CAF50;
        }
        
        #inputText {
            height: 300px;
            background-color: #fafafa;
        }
        
        #outputText {
            height: 300px;
            background-color: #f0fff0;
        }
        
        .button-container {
            text-align: center;
            margin: 20px 0;
        }
        
        button {
            background-color: #4CAF50;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 0 10px;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #45a049;
        }
        
        .secondary-btn {
            background-color: #008CBA;
        }
        
        .secondary-btn:hover {
            background-color: #007B9A;
        }
        
        .stats {
            background-color: #e8f5e8;
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
            border-left: 4px solid #4CAF50;
        }
        
        .stats-item {
            margin: 5px 0;
            color: #333;
        }
        
        .help-text {
            color: #666;
            font-size: 12px;
            margin-top: 10px;
            line-height: 1.4;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”— ED2Ké“¾æ¥å‡€åŒ–å™¨</h1>
        
        <div class="input-section">
            <label for="inputText">è¾“å…¥æ¡†ï¼ˆç²˜è´´åŒ…å«ed2ké“¾æ¥çš„æ–‡æœ¬ï¼‰ï¼š</label>
            <textarea id="inputText" placeholder="è¯·åœ¨æ­¤å¤„ç²˜è´´åŒ…å«ed2ké“¾æ¥çš„æ–‡æœ¬...

ç¤ºä¾‹ï¼š
&lt;p&gt;ed2k://|file|example_video.mp4|1234567890|ABC123DEF456789012345678901234567890|/&lt;/p&gt;
ed2kåˆ é™¤://|file|sample_file.mp4|9876543210|DEF456ABC789012345678901234567890123|h=XYZABC123DEFGHI456JKLMNO789PQRSTUV|/
ed2k://%7Cfile%7C%20demo_content.mp4%7C1357924680%7CGHI789JKL012345678901234567890ABCDEF%7Ch=MNOPQR456STUVWX789ABCDEF012345GHIJK%7C/"></textarea>
            <div class="help-text">
                æ”¯æŒçš„æ ¼å¼ï¼šHTMLæ ‡ç­¾åŒ…è£¹çš„é“¾æ¥ã€URLç¼–ç çš„é“¾æ¥ã€åŒ…å«"åˆ é™¤"å­—æ ·çš„é“¾æ¥ç­‰
            </div>
        </div>
        
        <div class="button-container">
            <button onclick="purifyLinks()">ğŸ§¹ å‡€åŒ–é“¾æ¥</button>
            <button onclick="clearAll()" class="secondary-btn">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰</button>
            <button onclick="copyOutput()" class="secondary-btn">ğŸ“‹ å¤åˆ¶ç»“æœ</button>
        </div>
        
        <div class="output-section">
            <label for="outputText">è¾“å‡ºæ¡†ï¼ˆå‡€åŒ–åçš„ed2ké“¾æ¥ï¼‰ï¼š</label>
            <textarea id="outputText" readonly placeholder="å‡€åŒ–åçš„ed2ké“¾æ¥å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..."></textarea>
        </div>
        
        <div id="stats" class="stats" style="display: none;">
            <div class="stats-item">âœ… <span id="validCount">0</span> ä¸ªæœ‰æ•ˆé“¾æ¥</div>
            <div class="stats-item">âŒ <span id="invalidCount">0</span> ä¸ªæ— æ•ˆé“¾æ¥è¢«è¿‡æ»¤</div>
            <div class="stats-item">ğŸ”§ <span id="fixedCount">0</span> ä¸ªé“¾æ¥è¢«ä¿®å¤</div>
        </div>
    </div>

    <script>
        function purifyLinks() {
            const inputText = document.getElementById('inputText').value;
            const outputTextarea = document.getElementById('outputText');
            const statsDiv = document.getElementById('stats');
            
            if (!inputText.trim()) {
                alert('è¯·å…ˆè¾“å…¥åŒ…å«ed2ké“¾æ¥çš„æ–‡æœ¬ï¼');
                return;
            }
            
            const result = extractAndPurifyEd2kLinks(inputText);
            
            outputTextarea.value = result.validLinks.join('\n');
            
            // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
            document.getElementById('validCount').textContent = result.validLinks.length;
            document.getElementById('invalidCount').textContent = result.invalidCount;
            document.getElementById('fixedCount').textContent = result.fixedCount;
            statsDiv.style.display = 'block';
            
            // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
            outputTextarea.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        
        function extractAndPurifyEd2kLinks(text) {
            const validLinks = [];
            let invalidCount = 0;
            let fixedCount = 0;
            
            // å°†æ–‡æœ¬æŒ‰è¡Œåˆ†å‰²
            const lines = text.split('\n');
            
            for (let line of lines) {
                line = line.trim();
                if (!line) continue;
                
                // æå–å¯èƒ½çš„ed2ké“¾æ¥
                const potentialLinks = extractPotentialEd2kLinks(line);
                
                for (let link of potentialLinks) {
                    const purifiedLink = purifyEd2kLink(link);
                    
                    if (purifiedLink.isValid) {
                        validLinks.push(purifiedLink.link);
                        if (purifiedLink.wasFixed) {
                            fixedCount++;
                        }
                    } else {
                        invalidCount++;
                    }
                }
            }
            
            return {
                validLinks: [...new Set(validLinks)], // å»é‡
                invalidCount,
                fixedCount
            };
        }
        
        function extractPotentialEd2kLinks(text) {
            const links = [];
            
            // 1. ä»HTMLæ ‡ç­¾ä¸­æå–ed2ké“¾æ¥
            const htmlRegex = /<[^>]*>(ed2k[^<]*)<\/[^>]*>/gi;
            let htmlMatch;
            while ((htmlMatch = htmlRegex.exec(text)) !== null) {
                links.push(htmlMatch[1]);
            }
            
            // 2. åŒ¹é…URLç¼–ç çš„ed2ké“¾æ¥ï¼ˆ%7Cç­‰ï¼‰
            const encodedRegex = /ed2k[^:]*:%[0-9A-F]{2}[^\s<>]*/gi;
            const encodedMatches = text.match(encodedRegex);
            if (encodedMatches) {
                links.push(...encodedMatches);
            }
            
            // 3. ç›´æ¥åŒ¹é…ed2ké“¾æ¥ï¼ˆåŒ…æ‹¬å„ç§å˜å½¢ï¼‰
            const ed2kRegex = /ed2k[^:]*:\/\/[^\s<>]+/gi;
            const matches = text.match(ed2kRegex);
            if (matches) {
                links.push(...matches);
            }
            
            // 4. åŒ¹é…åŒ…å«|file|çš„ç‰‡æ®µ
            const fileRegex = /ed2k[^\s<>]*\|file\|[^\s<>]*/gi;
            const fileMatches = text.match(fileRegex);
            if (fileMatches) {
                for (let match of fileMatches) {
                    if (!links.some(link => link.includes(match) || match.includes(link))) {
                        links.push(match);
                    }
                }
            }
            
            return links;
        }
        
        function purifyEd2kLink(link) {
            let originalLink = link;
            let wasFixed = false;
            
            // 1. å»é™¤HTMLæ ‡ç­¾
            link = link.replace(/<[^>]*>/g, '');
            
            // 2. å¤„ç†"åˆ é™¤"ç­‰å¹²æ‰°è¯
            if (link.includes('åˆ é™¤')) {
                link = link.replace(/åˆ é™¤/g, '');
                wasFixed = true;
            }
            
            // 3. URLè§£ç 
            if (link.includes('%')) {
                try {
                    link = decodeURIComponent(link);
                    wasFixed = true;
                } catch (e) {
                    // å¦‚æœè§£ç å¤±è´¥ï¼Œç»§ç»­ä½¿ç”¨åŸé“¾æ¥
                }
            }
            
            // 4. ä¿®å¤åè®®éƒ¨åˆ†
            if (!link.startsWith('ed2k://')) {
                // å¤„ç†å„ç§å˜å½¢
                link = link.replace(/^ed2k[^:]*:[\/\%]*[\/\%]*/i, 'ed2k://');
                wasFixed = true;
            }
            
            // 5. ç¡®ä¿é“¾æ¥ä»¥æ­£ç¡®çš„æ ¼å¼ç»“å°¾
            if (!link.endsWith('/') && link.includes('|file|')) {
                link += '/';
                wasFixed = true;
            }
            
            // 6. æ¸…ç†å¤šä½™çš„ç©ºæ ¼ï¼ˆä½†ä¿ç•™æ–‡ä»¶åä¸­çš„ç©ºæ ¼ï¼‰
            // åªåœ¨é“¾æ¥å¼€å¤´å’Œç»“å°¾å»é™¤ç©ºæ ¼
            link = link.trim();
            
            // 7. éªŒè¯ed2ké“¾æ¥æ ¼å¼
            const isValid = validateEd2kLink(link);
            
            return {
                link: link,
                isValid,
                wasFixed: wasFixed || (originalLink !== link)
            };
        }
        
        function validateEd2kLink(link) {
            // åŸºæœ¬æ ¼å¼éªŒè¯ï¼šed2k://|file|æ–‡ä»¶å|å¤§å°|å“ˆå¸Œå€¼|å¯é€‰å‚æ•°|/
            // å“ˆå¸Œå€¼å¿…é¡»æ˜¯32ä½åå…­è¿›åˆ¶ï¼Œå¯èƒ½æœ‰é¢å¤–çš„h=å‚æ•°
            const ed2kPattern = /^ed2k:\/\/\|file\|[^|]+\|\d+\|[A-F0-9]{32}\|.*\|?\/?$/i;
            return ed2kPattern.test(link);
        }
        
        function clearAll() {
            document.getElementById('inputText').value = '';
            document.getElementById('outputText').value = '';
            document.getElementById('stats').style.display = 'none';
        }
        
        function copyOutput() {
            const outputText = document.getElementById('outputText');
            if (!outputText.value.trim()) {
                alert('æ²¡æœ‰å¯å¤åˆ¶çš„å†…å®¹ï¼è¯·å…ˆå‡€åŒ–é“¾æ¥ã€‚');
                return;
            }
            
            outputText.select();
            document.execCommand('copy');
            
            // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸæç¤º
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = 'âœ… å·²å¤åˆ¶';
            button.style.backgroundColor = '#28a745';
            
            setTimeout(() => {
                button.textContent = originalText;
                button.style.backgroundColor = '#008CBA';
            }, 2000);
        }
        
        // æ·»åŠ é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'Enter':
                        e.preventDefault();
                        purifyLinks();
                        break;
                    case 'r':
                        e.preventDefault();
                        clearAll();
                        break;
                }
            }
        });
        
        // è‡ªåŠ¨è°ƒæ•´æ–‡æœ¬æ¡†é«˜åº¦
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 500) + 'px';
        }
        
        document.getElementById('inputText').addEventListener('input', function() {
            autoResize(this);
        });
    </script>
</body>
</html>
